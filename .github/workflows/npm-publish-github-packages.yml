# This workflow will run tests using node and then publish a package to GitHub Packages when a release is created
# For more information see: https://help.github.com/actions/language-and-framework-guides/publishing-nodejs-packages

name: Node.js Package

# è§¦å‘å·¥ä½œæµç¨‹çš„äº‹ä»¶
on:
  push:
    branches:
      - main
      - "releases/**"
      - "!releases/**-alpha"
      - dev
  pull_request:
    branches:
      - main
      - "releases/**"
      - dev
  release:
    types: [created]

# æƒé™
# permissions: write-all

# æŒ‰é¡ºåºè¿è¡Œä½œä¸š
jobs:
  publish-gpr:
    # æŒ‡å®šçš„è¿è¡Œå™¨ç¯å¢ƒ
    runs-on: ubuntu-latest
    # permissions:
    #   contents: write
    #   packages: write
    # è®¾ç½® node ç‰ˆæœ¬
    strategy:
      matrix:
        node-version: [16]
    steps:
      # æ‹‰å– github ä»“åº“ä»£ç 
      - uses: actions/checkout@v3
      # è®¾å®š node ç¯å¢ƒ
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          # è®¾ç½®å‘åŒ… npm åœ°å€ä»“åº“
          registry-url: https://registry.npmjs.org
      # æ‰§è¡Œå•æ¡è„šæœ¬
      - name: Run a one-line script
        run: echo Hello, world!
      # è®¾ç½®ç¯å¢ƒå˜é‡
      - name: Print a greeting
        env:
          MY_VAR: Hi there! My name is
          FIRST_NAME: Mona
          MIDDLE_NAME: The
          LAST_NAME: Octocat
        run: |
          echo $MY_VAR $FIRST_NAME $MIDDLE_NAME $LAST_NAME.
      # ä½¿ç”¨æ¡ä»¶åˆ¤æ–­
      - if: ${{ env.MY_VAR != '' }}
        run: echo 'This step will only run if the secret has a value set.'

      # - run: npm ci
      #  è®¾å®šå®‰è£…å·¥å…·ä¸º yarn
      # - name: Global install Yarn ğŸ”¨
      #   run: npm install -g yarn

      # å®‰è£…ä¾èµ–ï¼Œç›¸å½“äº npm ci
      - name: Install dependencies ğŸ“¦ï¸
        run: npm install
      # æ‰§è¡Œæ„å»ºæ­¥éª¤
      - name: æ„å»º
        run: |
          npm run build
      # æ‰§è¡Œéƒ¨ç½²
      - name: éƒ¨ç½²
        # è¿™ä¸ª action ä¼šæ ¹æ®é…ç½®è‡ªåŠ¨æ¨é€ä»£ç åˆ°æŒ‡å®šåˆ†æ”¯
        uses: JamesIves/github-pages-deploy-action@releases/v3
        with:
          # æŒ‡å®šå¯†é’¥ï¼Œå³åœ¨ç¬¬ä¸€æ­¥ä¸­è®¾ç½®çš„
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          # æŒ‡å®šæ¨é€åˆ°çš„è¿œç¨‹åˆ†æ”¯
          BRANCH: pages
          # æŒ‡å®šæ„å»ºä¹‹åçš„äº§ç‰©è¦æ¨é€å“ªä¸ªç›®å½•çš„ä»£ç 
          FOLDER: build
      - name: Print Env ğŸ“„
        run: |
          echo "node"
          node -v
          echo "npm"
          npm -v
          echo "yarn"
          yarn -v
      - run: npm publish
        env:
          # åˆšåˆšè®¾ç½®çš„ NPM_TOKEN
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
